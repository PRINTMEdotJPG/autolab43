{% extends "base.html" %}
{% load static %}

{% block title %}Расчет результатов эксперимента{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Эксперимент #<span id="experiment-id">{{ experiment_id }}</span>: Расчет результатов</h2>
    <hr>

    <div id="experiment-data-loading" class="alert alert-info">
        Загрузка данных эксперимента...
    </div>

    <div id="experiment-data-container" style="display: none;">
        <h4>Данные эксперимента:</h4>
        <p><strong>Температура воздуха:</strong> <span id="temperature"></span> °C</p>
        
        <div id="stages-data">
            <!-- Данные по этапам будут добавлены сюда динамически -->
        </div>

        <hr>
        <h4>Графики минимумов по этапам:</h4>
        <div id="charts-container" class="mb-4">
            <!-- Графики будут добавлены сюда динамически -->
        </div>
        
        <hr>
        <h4>Ваши расчеты:</h4>
        <form id="student-results-form">
            {% csrf_token %}
            <div class="form-group mb-3">
                <label for="student-speed">Рассчитанная скорость звука (м/с):</label>
                <input type="number" step="0.01" class="form-control" id="student-speed" name="student_speed" required>
            </div>
            <div class="form-group mb-3">
                <label for="student-gamma">Рассчитанный показатель адиабаты:</label>
                <input type="number" step="0.001" class="form-control" id="student-gamma" name="student_gamma" required>
            </div>
            <button type="submit" class="btn btn-primary">Отправить результаты</button>
        </form>
        <div id="form-message" class="mt-3"></div>
    </div>

    <div id="experiment-data-error" class="alert alert-danger" style="display: none;">
        Не удалось загрузить данные эксперимента. Пожалуйста, попробуйте позже или обратитесь к преподавателю.
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const experimentId = {{ experiment_id }};
        const experimentDataLoading = document.getElementById('experiment-data-loading');
        const experimentDataContainer = document.getElementById('experiment-data-container');
        const experimentDataError = document.getElementById('experiment-data-error');
        
        const temperatureEl = document.getElementById('temperature');
        const stagesDataEl = document.getElementById('stages-data');
        const chartsContainerEl = document.getElementById('charts-container');
        
        const studentResultsForm = document.getElementById('student-results-form');
        const formMessageEl = document.getElementById('form-message');

        fetch(`/api/experiment/${experimentId}/student-data/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                experimentDataLoading.style.display = 'none';
                if (data.status === 'success') {
                    experimentDataContainer.style.display = 'block';
                    temperatureEl.textContent = data.global_temperature;

                    console.log('Получены данные эксперимента:', data);

                    // Ограничиваем общий контейнер для улучшения производительности
                    chartsContainerEl.style.maxHeight = '800px';
                    chartsContainerEl.style.overflowY = 'auto';

                    data.stages.forEach((stage, index) => {
                        console.log(`Этап ${stage.stage_number}, данные минимумов:`, stage.minima);
                        
                        const chartId = `chart-stage-${stage.stage_number}`;
                        
                        chartsContainerEl.innerHTML += `
                            <div class="card mb-3">
                                <div class="card-header bg-light py-1">
                                    <h5 class="mb-0">Этап ${stage.stage_number} (Частота: ${stage.frequency} Hz)</h5>
                                </div>
                                <div class="card-body p-2">
                                    <div class="chart-container" style="height: 180px;">
                                        <canvas id="${chartId}"></canvas>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Подготавливаем данные для графика
                        const minimaData = stage.minima ? stage.minima.map(m => ({
                            position: m.position,
                            amplitude: m.amplitude
                        })) : [];
                        
                        console.log(`График ${chartId}, данные позиций/амплитуд:`, minimaData);
                        
                        setTimeout(() => {
                            if (minimaData.length > 0) {
                                // График амплитуды от позиции
                                new Chart(document.getElementById(chartId), {
                                    type: 'scatter',
                                    data: {
                                        datasets: [{
                                            label: `Амплитуда сигнала (Этап ${stage.stage_number})`,
                                            data: minimaData.map(m => ({
                                                x: m.position,
                                                y: m.amplitude
                                            })),
                                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                            borderColor: 'rgb(75, 192, 192)',
                                            pointRadius: 5,
                                            pointHoverRadius: 7
                                        }]
                                    },
                                    options: {
                                        animation: false, // Отключаем анимацию для повышения производительности
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        return `Позиция: ${context.raw.x}, Амплитуда: ${context.raw.y.toExponential(4)}`;
                                                    }
                                                }
                                            },
                                            legend: {
                                                position: 'top',
                                                labels: {
                                                    boxWidth: 12,
                                                    font: {
                                                        size: 11
                                                    }
                                                },
                                                display: true
                                            }
                                        },
                                        scales: {
                                            x: {
                                                title: {
                                                    display: true,
                                                    text: 'Позиция',
                                                    font: {
                                                        size: 10
                                                    }
                                                },
                                                ticks: {
                                                    font: {
                                                        size: 10
                                                    }
                                                }
                                            },
                                            y: {
                                                title: {
                                                    display: true,
                                                    text: 'Амплитуда',
                                                    font: {
                                                        size: 10
                                                    }
                                                },
                                                ticks: {
                                                    font: {
                                                        size: 10
                                                    },
                                                    callback: function(value) {
                                                        return value.toExponential(1);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                                console.log(`График амплитуды ${chartId} успешно создан`);
                            } else {
                                const chartElement = document.getElementById(chartId);
                                if (chartElement) {
                                    chartElement.outerHTML = `<div class="alert alert-warning text-center p-1 small">Нет данных для построения графика.</div>`;
                                }
                            }
                        }, 0);
                    });

                } else {
                    experimentDataError.textContent = data.message || 'Произошла ошибка при загрузке данных.';
                    experimentDataError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching experiment data:', error);
                experimentDataLoading.style.display = 'none';
                experimentDataError.textContent = `Ошибка сети или сервера: ${error.message}. Пожалуйста, проверьте ваше подключение или попробуйте позже.`;
                experimentDataError.style.display = 'block';
            });

        studentResultsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            formMessageEl.textContent = '';
            formMessageEl.className = 'mt-3';

            const formData = new FormData(studentResultsForm);
            const studentSpeed = formData.get('student_speed');
            const studentGamma = formData.get('student_gamma');

            fetch(`/lab_data/api/experiment/${experimentId}/save-results/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken') 
                },
                body: JSON.stringify({
                    student_speed: parseFloat(studentSpeed),
                    student_gamma: parseFloat(studentGamma)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    formMessageEl.textContent = 'Ваши результаты успешно отправлены! ' + (data.message || '');
                    formMessageEl.classList.add('alert', 'alert-success');
                    studentResultsForm.reset();
                    const submitButton = studentResultsForm.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = true;
                    }
                } else {
                    formMessageEl.textContent = 'Ошибка при отправке: ' + (data.message || 'Проверьте введенные данные.');
                    formMessageEl.classList.add('alert', 'alert-danger');
                }
            })
            .catch(error => {
                console.error('Error submitting results:', error);
                formMessageEl.textContent = 'Сетевая ошибка или ошибка сервера при отправке результатов.';
                formMessageEl.classList.add('alert', 'alert-danger');
            });
        });
    });
</script>
{% endblock %} 