{% extends "base.html" %}
{% load static %}

{% block title %}Расчет результатов эксперимента{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Эксперимент #<span id="experiment-id">{{ experiment_id }}</span>: Расчет результатов</h2>
    <hr>

    <div id="experiment-data-loading" class="alert alert-info">
        Загрузка данных эксперимента...
    </div>

    <div id="experiment-data-container" style="display: none;">
        <h4>Данные эксперимента:</h4>
        <p><strong>Температура воздуха:</strong> <span id="temperature"></span> °C</p>
        
        <div id="stages-data">
            <!-- Данные по этапам будут добавлены сюда динамически -->
        </div>

        <!-- НАЧАЛО: Блок для отладочной информации -->
        <div id="debug-info-container" style="display: none; margin-top: 20px; padding: 15px; border: 1px dashed #ccc; background-color: #f9f9f9;">
            <h5><span class="badge bg-warning">Отладочная информация</span></h5>
            
            <h6>Системные расчеты:</h6>
            <p><strong>Рассчитанная скорость звука (система, м/с):</strong> <span id="system-speed-of-sound"></span></p>
            <p><strong>Рассчитанный показатель адиабаты (γ):</strong> <span id="system-gamma"></span></p>
            <p><strong>Пользовательская ошибка по γ (%):</strong> <span id="user-gamma-error"></span></p>
            
            <h4>Отладочная информация (Расчеты системы)</h4>
            <h6>Детали по этапам (включая таблицы минимумов):</h6>
            <div id="debug-stages-details">
                <!-- Отладочная информация по этапам будет сюда добавлена -->
            </div>
        </div>
        <!-- КОНЕЦ: Блок для отладочной информации -->

        <hr>
        <h4>Графики минимумов по этапам:</h4>
        <div id="charts-container" class="mb-4">
            <!-- Графики будут добавлены сюда динамически -->
        </div>
        
        <hr>
        <h4>Ваши расчеты:</h4>
        <form id="student-results-form">
            {% csrf_token %}
            <div class="form-group mb-3">
                <label for="student-speed">Рассчитанная скорость звука (м/с):</label>
                <input type="number" step="0.01" class="form-control" id="student-speed" name="student_speed" required>
            </div>
            <div class="form-group mb-3">
                <label for="student-gamma">Рассчитанный показатель адиабаты:</label>
                <input type="number" step="0.001" class="form-control" id="student-gamma" name="student_gamma" required>
            </div>
            <button type="submit" class="btn btn-primary">Отправить результаты</button>
        </form>
        <div id="form-message" class="mt-3"></div>
    </div>

    <div id="experiment-data-error" class="alert alert-danger" style="display: none;">
        Не удалось загрузить данные эксперимента. Пожалуйста, попробуйте позже или обратитесь к преподавателю.
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.2.0/chartjs-plugin-zoom.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const experimentId = {{ experiment_id }};
        const experimentDataLoading = document.getElementById('experiment-data-loading');
        const experimentDataContainer = document.getElementById('experiment-data-container');
        const experimentDataError = document.getElementById('experiment-data-error');
        
        const temperatureEl = document.getElementById('temperature');
        const stagesDataEl = document.getElementById('stages-data');
        const chartsContainerEl = document.getElementById('charts-container');
        
        const studentResultsForm = document.getElementById('student-results-form');
        const formMessageEl = document.getElementById('form-message');

        fetch(`/api/experiment/${experimentId}/student-data/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                experimentDataLoading.style.display = 'none';
                if (data.status === 'success') {
                    experimentDataContainer.style.display = 'block';
                    temperatureEl.textContent = data.global_temperature_celsius;

                    console.log('Получены данные эксперимента:', data);

                    const debugInfoContainer = document.getElementById('debug-info-container');
                    const debugSystemGammaEl = document.getElementById('debug-system-gamma');
                    const debugStagesDetailsEl = document.getElementById('debug-stages-details');

                    // --- НАЧАЛО ИЗМЕНЕНИЯ: Обновление заголовка отладочной информации ---
                    const debugHeaderSpan = debugInfoContainer.querySelector('h5 > span.badge');
                    if (debugHeaderSpan) {
                        if (data.results_processing_status === 'success' || data.experiment_status_raw === 'completed') {
                            debugHeaderSpan.textContent = 'Завершен';
                            debugHeaderSpan.classList.remove('bg-warning');
                            debugHeaderSpan.classList.add('bg-success');
                        }
                        // Если не выполнены условия выше, заголовок останется "Отладочная информация" с классом bg-warning
                    }
                    // --- КОНЕЦ ИЗМЕНЕНИЯ ---

                    if (data.debug_mode_for_student_profile) {
                        debugInfoContainer.style.display = 'block';
                        
                        if (debugSystemGammaEl) {
                            if (data.system_calculated_results) {
                                debugSystemGammaEl.textContent = data.system_calculated_results.gamma !== null && data.system_calculated_results.gamma !== undefined ? data.system_calculated_results.gamma.toFixed(4) : 'Нет данных';
                            } else {
                                debugSystemGammaEl.textContent = 'Нет данных';
                            }
                        }

                        if (debugStagesDetailsEl) {
                            debugStagesDetailsEl.innerHTML = '';
                            data.stages.forEach(stage => {
                                let stageHtml = `<div class="mb-2 p-2 border rounded"><strong>Этап ${stage.stage_number} (Частота: ${stage.frequency_hz} Hz):</strong><br>`;
                                if (stage.minima_table && stage.minima_table.length > 0) {
                                    stageHtml += '<table class="table table-sm table-bordered w-auto"><thead><tr><th>№</th><th>L, м</th></tr></thead><tbody>';
                                    stage.minima_table.forEach(m => {
                                        stageHtml += `<tr><td>${m.minimum_number}</td><td>${m.position_m}</td></tr>`;
                                    });
                                    stageHtml += '</tbody></table>';
                                } else {
                                    stageHtml += '<p class="text-muted small">Таблица минимумов отсутствует или пуста.</p>';
                                }
                                stageHtml += `Среднее ΔL: ${stage.average_delta_l_m !== null && stage.average_delta_l_m !== undefined ? stage.average_delta_l_m + ' м' : 'Нет данных'}<br>`;
                                stageHtml += '</div>';
                                debugStagesDetailsEl.innerHTML += stageHtml;
                            });
                        }

                    } else {
                        debugInfoContainer.style.display = 'none';
                    }

                    chartsContainerEl.style.maxHeight = '800px';
                    chartsContainerEl.style.overflowY = 'auto';

                    // --- НАЧАЛО ИЗМЕНЕНИЙ ДЛЯ ГРАФИКОВ ---
                    let allChartsHtml = '';
                    console.log('[ChartJS Setup] Начало генерации HTML для графиков.');

                    data.stages.forEach((stage, index) => {
                        const chartCanvasId = 'chart-stage-' + stage.id;
                        console.log('[ChartJS Setup] Генерация HTML для этапа ' + stage.stage_number + ' (ID: ' + stage.id + '), Canvas ID: ' + chartCanvasId);
                        // Упрощенный HTML без переносов строк внутри строки JS, используем одинарные кавычки для HTML атрибутов
                        allChartsHtml += '<div class="card mb-3"><div class="card-header">График для Этапа ' + stage.stage_number + ' (Частота: ' + stage.frequency_hz + ' Hz)</div><div class="card-body"><canvas id="' + chartCanvasId + '" style="height: 220px;"></canvas></div></div>';
                    });

                    chartsContainerEl.innerHTML = allChartsHtml;
                    console.log('[ChartJS Setup] Весь HTML для графиков вставлен в DOM.');

                    if (!window.charts) {
                        window.charts = {};
                        console.log('[ChartJS Setup] window.charts инициализирован.');
                    }

                    data.stages.forEach((stage, index) => {
                        const chartCanvasId = 'chart-stage-' + stage.id;
                        const canvasElement = document.getElementById(chartCanvasId);

                        if (!canvasElement) {
                            console.error('[ChartJS Init - Этап ' + stage.stage_number + '] Canvas элемент "' + chartCanvasId + '" НЕ НАЙДЕН в DOM после вставки HTML.');
                            return;
                        }
                        console.log('[ChartJS Init - Этап ' + stage.stage_number + '] Canvas элемент "' + chartCanvasId + '" найден. Инициализация графика.');
                        const ctx = canvasElement.getContext('2d');

                        const datasets = [];
                        let chartHasData = false;

                        // 1. Полный аудиосигнал (основная линия)
                        if (stage.full_signal_data && 
                            Array.isArray(stage.full_signal_data) &&
                            stage.full_signal_data.length > 0) {
                            
                            // Предполагаем, что full_signal_data это уже массив объектов {position: X, amplitude: Y}
                            // Преобразуем в {x, y} для Chart.js
                            const fullSignalPoints = stage.full_signal_data.map(p => ({
                                x: p.position, // Убедитесь, что ключ 'position' правильный
                                y: p.amplitude  // Убедитесь, что ключ 'amplitude' правильный
                            }));

                            console.log('[ChartJS Data - Этап ' + stage.stage_number + '] ПОЛНЫЙ СИГНАЛ (обработан): Длина ' + fullSignalPoints.length + '. Первые 3 точки: ' + JSON.stringify(fullSignalPoints.slice(0,3)));
                            datasets.push({
                                label: 'Амплитуда сигнала (Этап ' + stage.stage_number + ')',
                                data: fullSignalPoints,
                                borderColor: 'rgba(0, 123, 255, 0.8)',
                                borderWidth: 1,
                                pointRadius: 0, 
                                fill: false,
                                showLine: true,
                                type: 'line', 
                                tension: 0.1,
                                order: 1 
                            });
                            chartHasData = true;
                        } else {
                            console.warn('[ChartJS Data - Этап ' + stage.stage_number + '] ПОЛНЫЙ СИГНАЛ: Данные отсутствуют, некорректны или неполны.', stage.full_signal_data);
                        }

                        // 2. Найденные минимумы (точки)
                        let minimaSource = stage.minima; 
                        if (!minimaSource && stage.minima_table) { 
                            console.warn('[ChartJS Data - Этап ' + stage.stage_number + '] stage.minima отсутствует, используется stage.minima_table для минимумов.');
                            minimaSource = stage.minima_table.map(m => ({ distance_cm: m.position_m, amplitude: m.amplitude })); // Предполагаем m.amplitude существует или = 0.01
                        }

                        if (minimaSource && Array.isArray(minimaSource) && minimaSource.length > 0) {
                            const minimaPoints = minimaSource.map(m => ({
                                x: m.distance_cm, // Убедитесь что это правильное поле для X
                                y: (m.amplitude !== undefined && m.amplitude !== null) ? m.amplitude : 0.01 // Используем amplitude если есть, иначе 0.01
                            }));
                            console.log('[ChartJS Data - Этап ' + stage.stage_number + '] МИНИМУМЫ: Длина ' + minimaPoints.length + '. Первые 3 точки: ' + JSON.stringify(minimaPoints.slice(0,3)));
                            datasets.push({
                                label: 'Найденные минимумы (Этап ' + stage.stage_number + ')',
                                data: minimaPoints,
                                backgroundColor: 'rgba(255, 99, 132, 1)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                showLine: false, 
                                type: 'scatter', 
                                order: 0 
                            });
                            chartHasData = true;
                        } else {
                             console.warn('[ChartJS Data - Этап ' + stage.stage_number + '] МИНИМУМЫ: Данные отсутствуют или пусты.', minimaSource);
                        }
                        
                        if (!chartHasData) {
                            console.warn('[ChartJS Init - Этап ' + stage.stage_number + '] НЕТ ДАННЫХ для графика ' + chartCanvasId + '. Отрисовка отменена.');
                            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                            ctx.font = "16px Arial";
                            ctx.fillStyle = "rgb(150,150,150)";
                            ctx.textAlign = "center";
                            ctx.fillText('Нет данных для отображения графика.', canvasElement.width / 2, canvasElement.height / 2);
                            return; // Не создаем/обновляем график, если нет данных
                        }

                        console.log('[ChartJS Init - Этап ' + stage.stage_number + '] Попытка создания графика ' + chartCanvasId + ' с данными:', {datasets: datasets});

                        if (window.charts[chartCanvasId]) {
                            window.charts[chartCanvasId].data.datasets = datasets;
                            window.charts[chartCanvasId].update();
                        } else {
                            window.charts[chartCanvasId] = new Chart(ctx, {
                                // Тип графика по умолчанию будет 'line', но datasets могут его переопределить
                                data: {
                                    datasets: datasets
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            type: 'linear',
                                            position: 'bottom',
                                            title: {
                                                display: true,
                                                text: 'Положение трубы (см)'
                                            },
                                            ticks: {
                                                callback: function(value, index, ticks) {
                                                    return (value * 100).toFixed(0);
                                                }
                                            }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Амплитуда (отн. ед.)'
                                            }
                                        }
                                    },
                                    plugins: {
                                        zoom: {
                                            pan: {
                                                enabled: true,
                                                mode: 'xy'
                                            },
                                            zoom: {
                                                wheel: {
                                                    enabled: true,
                                                },
                                                pinch: {
                                                    enabled: true
                                                },
                                                mode: 'xy',
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) {
                                                        label += ': ';
                                                    }
                                                    if (context.parsed.y !== null) {
                                                        label += `Ампл.: ${context.parsed.y.toFixed(4)}`;
                                                    }
                                                    if (context.parsed.x !== null) {
                                                        label += `, Поз.: ${(context.parsed.x * 100).toFixed(1)} см`;
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        console.log('[ChartJS Init - Этап ' + stage.stage_number + '] График ' + chartCanvasId + ' успешно создан/обновлен.');
                    });
                    // --- КОНЕЦ ИЗМЕНЕНИЙ ДЛЯ ГРАФИКОВ ---


                    // Обновление состояния формы и сообщения
                    const studentSpeedInput = document.getElementById('student-speed');
                    const studentGammaInput = document.getElementById('student-gamma');
                    const submitButton = studentResultsForm.querySelector('button[type="submit"]');

                    // Заполняем поля, если есть данные от студента (даже если статус fail)
                    if (data.student_submitted_results) {
                        if (data.student_submitted_results.speed_of_sound !== null) {
                            studentSpeedInput.value = data.student_submitted_results.speed_of_sound;
                        }
                        if (data.student_submitted_results.gamma !== null) {
                            studentGammaInput.value = data.student_submitted_results.gamma;
                        }
                    }
                    
                    // Логика блокировки полей и отображения сообщений
                    if (data.results_processing_status === 'success' || data.results_processing_status === 'final_completed') { 
                        console.log('[Form State] Эксперимент успешно завершен. Заполняем и блокируем поля.');
                        studentSpeedInput.disabled = true;
                        studentGammaInput.disabled = true;
                        if (submitButton) { // Добавлена проверка на существование кнопки
                            submitButton.disabled = true;
                            submitButton.textContent = 'Результаты приняты';
                        }
                        
                        const speedErrorDisplay = data.error_percent_speed !== null && data.error_percent_speed !== undefined
                                                  ? data.error_percent_speed + '%'
                                                  : 'нет данных';
                        const gammaErrorDisplay = data.error_percent_gamma !== null && data.error_percent_gamma !== undefined
                                                  ? data.error_percent_gamma + '%'
                                                  : 'нет данных';
                        
                        const studentSpeedDisplay = data.student_submitted_results?.speed_of_sound ?? 'N/A';
                        const studentGammaDisplay = data.student_submitted_results?.gamma ?? 'N/A';

                        formMessageEl.innerHTML = `
                            <div class="alert alert-success">
                                <strong>Успех!</strong> Ваши результаты (${studentSpeedDisplay} м/с, γ=${studentGammaDisplay}) приняты.
                                <br>Отклонение от системных значений:
                                Скорость: ${speedErrorDisplay},
                                Гамма: ${gammaErrorDisplay}.
                            </div>`;
                    } else if (data.results_processing_status === 'fail') {
                        console.log('[Form State] Эксперимент завершен со статусом "fail". Поля остаются активными.');
                        studentSpeedInput.disabled = false;
                        studentGammaInput.disabled = false;
                        if (submitButton) { // Добавлена проверка
                           submitButton.disabled = false;
                           submitButton.textContent = 'Отправить результаты'; // Исходный текст кнопки
                        }

                        const genericFailMessage = "Ваши результаты не приняты. Отклонение от рассчитанных системой значений составило >5%.";
                        formMessageEl.innerHTML = `<div class="alert alert-danger">${genericFailMessage}</div>`;
                        
                    } else if (data.results_processing_status === 'pending_student_input' || data.results_processing_status === null || data.results_processing_status === undefined) {
                        console.log('[Form State] Эксперимент ожидает ввода данных студентом. Поля активны.');
                        studentSpeedInput.disabled = false;
                        studentGammaInput.disabled = false;
                        if (submitButton) { // Добавлена проверка
                            submitButton.disabled = false;
                            submitButton.textContent = 'Отправить результаты';
                        }
                        formMessageEl.innerHTML = '<div class="alert alert-info">Введите рассчитанные значения и отправьте результаты.</div>';
                    } else {
                        // Неизвестный статус, поля активны по умолчанию
                        console.warn('[Form State] Неизвестный статус обработки результатов: ' + data.results_processing_status + '. Поля активны.');
                        studentSpeedInput.disabled = false;
                        studentGammaInput.disabled = false;
                        if (submitButton) { // Добавлена проверка
                           submitButton.disabled = false;
                           submitButton.textContent = 'Отправить результаты';
                        }
                        formMessageEl.innerHTML = '<div class="alert alert-warning">Не удалось определить статус обработки. Поля ввода активны.</div>';
                    }


                } else {
                    experimentDataLoading.style.display = 'none';
                    experimentDataError.textContent = data.message || 'Произошла ошибка при загрузке данных.';
                    experimentDataError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Ошибка при получении данных эксперимента:', error);
                experimentDataLoading.style.display = 'none';
                experimentDataError.textContent = `Ошибка сети или сервера: ${error.message}. Попробуйте обновить страницу.`;
                experimentDataError.style.display = 'block';
            });

        studentResultsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            formMessageEl.innerHTML = '<div class="alert alert-info">Отправка результатов...</div>';
            const studentSpeed = document.getElementById('student-speed').value;
            const studentGamma = document.getElementById('student-gamma').value;
            const submitButtonInForm = studentResultsForm.querySelector('button[type="submit"]'); // Переименована переменная во избежание конфликта

            if (submitButtonInForm) { // Добавлена проверка
                submitButtonInForm.disabled = true;
            }

            fetch(`/test-save-results/${experimentId}/`, { // Изменено на тестовый URL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken() 
                },
                body: JSON.stringify({
                    student_speed: parseFloat(studentSpeed),
                    student_gamma: parseFloat(studentGamma)
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Ответ от save_results:", data);
                const speedInput = document.getElementById('student-speed'); // Получаем элементы заново
                const gammaInput = document.getElementById('student-gamma');
                const currentSubmitButton = studentResultsForm.querySelector('button[type="submit"]'); // Получаем кнопку заново

                if (data.status === 'success' && data.results_status) { 
                    if (speedInput) speedInput.disabled = (data.results_status === 'success' || data.results_status === 'final_completed');
                    if (gammaInput) gammaInput.disabled = (data.results_status === 'success' || data.results_status === 'final_completed');
                    if (currentSubmitButton) currentSubmitButton.disabled = (data.results_status === 'success' || data.results_status === 'final_completed');
                    
                    if (data.results_status === 'success' || data.results_status === 'final_completed') {
                        if (currentSubmitButton) currentSubmitButton.textContent = 'Результаты приняты';
                        
                        // Формируем сообщение об отклонениях
                        let deviationMessage = '';
                        const speedError = data.error_percent_speed !== null && data.error_percent_speed !== undefined 
                                           ? data.error_percent_speed + '%' 
                                           : 'нет данных';
                        const gammaError = data.error_percent_gamma !== null && data.error_percent_gamma !== undefined 
                                           ? data.error_percent_gamma + '%' 
                                           : 'нет данных';

                        if (data.student_values && data.system_values) { // Отображаем полные детали, если есть
                             deviationMessage = `<br>Ваши значения: Скорость ${data.student_values.speed} м/с, γ=${data.student_values.gamma}.<br>Системные значения: Скорость ${data.system_values.speed !== null ? data.system_values.speed + ' м/с' : 'N/A'}, γ=${data.system_values.gamma !== null ? data.system_values.gamma : 'N/A'}.<br>Отклонение: Скорость: ${speedError}, Гамма: ${gammaError}.`;
                        } else { // Базовое сообщение, если нет полных данных (маловероятно при успехе, но для подстраховки)
                             deviationMessage = `<br>Отклонение от системных значений: Скорость: ${speedError}, Гамма: ${gammaError}.`;
                        }
                        
                        formMessageEl.innerHTML = `
                            <div class="alert alert-success">
                                <strong>Успех!</strong> ${data.message || 'Ваши результаты приняты.'}
                                ${deviationMessage}
                            </div>`;
                    } else if (data.results_status === 'fail') {
                        if (currentSubmitButton) {
                            currentSubmitButton.disabled = false; 
                            currentSubmitButton.textContent = 'Отправить результаты';
                        }
                        const genericFailMessageForSubmit = "Ваши результаты не приняты. Отклонение от рассчитанных системой значений составило >5%.";
                        formMessageEl.innerHTML = `
                            <div class="alert alert-danger">
                                ${genericFailMessageForSubmit}
                            </div>`;
                    } else { 
                        if (currentSubmitButton) {
                             currentSubmitButton.disabled = false;
                             currentSubmitButton.textContent = 'Отправить результаты';
                        }
                        formMessageEl.innerHTML = `<div class="alert alert-info">${data.message || 'Статус не определен, попробуйте снова.'}</div>`;
                    }
                } else {
                    formMessageEl.innerHTML = `<div class="alert alert-danger">Ошибка при сохранении: ${data.message || 'Проверьте введенные данные или попробуйте позже.'}</div>`;
                    if (currentSubmitButton) currentSubmitButton.disabled = false; 
                }
            })
            .catch(error => {
                console.error('Ошибка при отправке результатов:', error);
                formMessageEl.innerHTML = '<div class="alert alert-danger">Сетевая ошибка при отправке результатов.</div>';
                const currentSubmitButton = studentResultsForm.querySelector('button[type="submit"]');
                if (currentSubmitButton) currentSubmitButton.disabled = false;
            });
        });

        function getCSRFToken() {
            const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            return tokenInput ? tokenInput.value : ''; // Добавлена проверка на существование элемента
        }
    });
</script>
{% endblock %} 