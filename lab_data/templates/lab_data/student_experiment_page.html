{% extends "base.html" %}
{% load static %}

{% block title %}Расчет результатов эксперимента{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Эксперимент #<span id="experiment-id">{{ experiment_id }}</span>: Расчет результатов</h2>
    <hr>

    <div id="experiment-data-loading" class="alert alert-info">
        Загрузка данных эксперимента...
    </div>

    <div id="experiment-data-container" style="display: none;">
        <h4>Данные эксперимента:</h4>
        <p><strong>Температура воздуха:</strong> <span id="temperature"></span> °C</p>
        
        <!-- <div id="stages-data" style="display: none;">
            Данные по этапам будут добавлены сюда динамически
        </div> -->

        <div id="debug-info-container" style="display: none; margin-top: 20px; padding: 15px; border: 1px dashed #ccc; background-color: #f9f9f9;">
            <h5><span class="badge bg-warning">Отладочная информация</span></h5>
            <h6>Системные расчеты (поэтапно):</h6>
            <div id="debug-system-results-stages">
            </div>
            <h4>Отладочная информация (Расчеты системы)</h4>
            <h6>Детали по этапам (включая таблицы минимумов):</h6>
            <div id="debug-stages-details">
            </div>
        </div>

        <hr>
        <h4>Графики минимумов по этапам:</h4>
        <div id="charts-container" class="mb-4">
        </div>
        
        <hr>
        <h4>Отладочная информация:</h4>
        <p>Статус обработки: <code id="results-processing-status-debug"></code></p>
        <div id="system-results-per-stage-debug" class="mt-2">
            <!-- Сюда будут выводиться системные результаты по этапам -->
        </div>

        <hr>
        <h4>Ваши расчеты:</h4>
        <form id="student-results-form">
            {% csrf_token %}
            <h5>Поэтапные значения:</h5>
            <h6>Этап 1 (Частота: <span class="stage-frequency" data-stage-num="1"></span> Hz)</h6>
            <div class="row">
                <div class="col-md-6 form-group mb-3">
                    <label for="student-speed-stage1">Скорость звука (этап 1, м/с):</label>
                    <input type="number" step="0.01" class="form-control" id="student-speed-stage1" name="student_speed_stage1" required>
                </div>
                <div class="col-md-6 form-group mb-3">
                    <label for="student-gamma-stage1">Показатель адиабаты (этап 1):</label>
                    <input type="number" step="0.001" class="form-control" id="student-gamma-stage1" name="student_gamma_stage1" required>
                </div>
            </div>

            <h6>Этап 2 (Частота: <span class="stage-frequency" data-stage-num="2"></span> Hz)</h6>
            <div class="row">
                <div class="col-md-6 form-group mb-3">
                    <label for="student-speed-stage2">Скорость звука (этап 2, м/с):</label>
                    <input type="number" step="0.01" class="form-control" id="student-speed-stage2" name="student_speed_stage2" required>
                </div>
                <div class="col-md-6 form-group mb-3">
                    <label for="student-gamma-stage2">Показатель адиабаты (этап 2):</label>
                    <input type="number" step="0.001" class="form-control" id="student-gamma-stage2" name="student_gamma_stage2" required>
                </div>
            </div>

            <h6>Этап 3 (Частота: <span class="stage-frequency" data-stage-num="3"></span> Hz)</h6>
            <div class="row">
                <div class="col-md-6 form-group mb-3">
                    <label for="student-speed-stage3">Скорость звука (этап 3, м/с):</label>
                    <input type="number" step="0.01" class="form-control" id="student-speed-stage3" name="student_speed_stage3" required>
                </div>
                <div class="col-md-6 form-group mb-3">
                    <label for="student-gamma-stage3">Показатель адиабаты (этап 3):</label>
                    <input type="number" step="0.001" class="form-control" id="student-gamma-stage3" name="student_gamma_stage3" required>
                </div>
            </div>
            <hr>
            <h5>Финальное значение (среднее по этапам):</h5>
            <div class="row">
                <div class="col-md-6 form-group mb-3">
                    <label for="student-final-gamma">Финальная гамма (средняя по этапам):</label>
                    <input type="number" step="0.001" class="form-control" id="student-final-gamma" name="student_final_gamma" required>
                    <small class="form-text text-muted">Рассчитайте как среднее арифметическое из трех ваших поэтапных значений гаммы.</small>
                </div>
            </div>

            <button type="submit" class="btn btn-primary mt-3">Отправить результаты</button>
        </form>
        <div id="form-message" class="mt-3">
        </div>

        <button type_button="button" class="btn btn-secondary mt-3" id="clear-storage-btn">Очистить сохраненные данные (для отладки)</button>
    </div>

    <div id="experiment-data-error" class="alert alert-danger" style="display: none;">
        Не удалось загрузить данные эксперимента. Пожалуйста, попробуйте позже или обратитесь к преподавателю.
    </div>
</div>

<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultsModalLabel">Результаты проверки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resultsModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.2.0/chartjs-plugin-zoom.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const experimentId = {{ experiment_id }};
        const experimentDataLoading = document.getElementById('experiment-data-loading');
        const experimentDataContainer = document.getElementById('experiment-data-container');
        const experimentDataError = document.getElementById('experiment-data-error');
        
        const temperatureEl = document.getElementById('temperature');
        // const stagesDataEl = document.getElementById('stages-data'); // Закомментировано
        const chartsContainerEl = document.getElementById('charts-container');
        
        const studentResultsForm = document.getElementById('student-results-form');
        const formMessageEl = document.getElementById('form-message');
        const resultsModalBodyEl = document.getElementById('resultsModalBody');
        const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));

        const debugInfoContainer = document.getElementById('debug-info-container');
        const debugSystemResultsStagesEl = document.getElementById('debug-system-results-stages');
        const debugStagesDetailsEl = document.getElementById('debug-stages-details');

        /* // Закомментированная функция displayStageTableData и ее использование
        function displayStageTableData(stage) {
            let stageHtml = `<div class="card mb-3"><div class="card-header"><strong>Этап ${stage.stage_number} (Частота: ${stage.frequency_hz} Hz)</strong></div><div class="card-body">`;
            if (stage.minima_table && stage.minima_table.length > 0) {
                stageHtml += '<h6>Таблица положений минимумов:</h6><table class="table table-sm table-bordered w-auto"><thead><tr><th>№ минимума</th><th>Положение L, м</th></tr></thead><tbody>';
                stage.minima_table.forEach(m => {
                    stageHtml += `<tr><td>${m.minimum_number}</td><td>${m.position_m}</td></tr>`;
                });
                stageHtml += '</tbody></table>';
            } else {
                stageHtml += '<p class="text-muted small">Таблица минимумов для этого этапа отсутствует или пуста.</p>';
            }
            stageHtml += `<p><strong>Среднее ΔL:</strong> ${stage.average_delta_l_m !== null && stage.average_delta_l_m !== undefined ? stage.average_delta_l_m + ' м' : 'Нет данных'}</p>`;
            stageHtml += '</div></div>';
            return stageHtml;
        }
        */

        fetch(`/api/experiment/${experimentId}/student-data/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                experimentDataLoading.style.display = 'none';
                if (data.status === 'success') {
                    experimentDataContainer.style.display = 'block';
                    temperatureEl.textContent = data.global_temperature_celsius;

                    console.log('Получены данные эксперимента (для студента):', data);

                    data.stages.forEach((stage, index) => {
                        const freqSpan = document.querySelector(`.stage-frequency[data-stage-num="${index + 1}"]`);
                        if (freqSpan) {
                            freqSpan.textContent = stage.frequency_hz || 'N/A';
                        }
                    });

                    /* // Закомментирован блок, использующий stagesDataEl и displayStageTableData
                    let stagesTableHtml = '';
                    if (data.stages && data.stages.length > 0) {
                         data.stages.forEach(stage => {
                            stagesTableHtml += displayStageTableData(stage);
                        });
                    } else {
                        stagesTableHtml = '<p class="text-muted">Данные по этапам не загружены.</p>';
                    }
                    stagesDataEl.innerHTML = stagesTableHtml;
                    */

                    if (data.debug_mode_for_student_profile && data.system_results_per_stage) {
                        debugInfoContainer.style.display = 'block';
                        let debugSystemHtml = '';
                        data.system_results_per_stage.forEach(stageRes => {
                            debugSystemHtml += `<p><strong>Этап ${stageRes.stage}:</strong> Скорость: ${stageRes.speed ? stageRes.speed.toFixed(2) : 'N/A'} м/с, Гамма: ${stageRes.gamma ? stageRes.gamma.toFixed(3) : 'N/A'}</p>`;
                        });
                        debugSystemResultsStagesEl.innerHTML = debugSystemHtml || '<p>Системные расчеты по этапам не доступны.</p>';

                        debugStagesDetailsEl.innerHTML = '';
                        data.stages.forEach(stage => {
                            let stageDebugDetailHtml = `<div class="mb-2 p-2 border rounded"><strong>Этап ${stage.stage_number} (Частота: ${stage.frequency_hz} Hz):</strong><br>`;
                            if (stage.minima_table && stage.minima_table.length > 0) {
                                stageDebugDetailHtml += 'Таблица минимумов (сырые данные): <pre>' + JSON.stringify(stage.minima_table, null, 2) + '</pre>';
                            } else {
                                stageDebugDetailHtml += '<p class="text-muted small">Таблица минимумов отсутствует или пуста.</p>';
                            }
                            stageDebugDetailHtml += `Среднее ΔL (сырое): ${stage.average_delta_l_m}<br>`;
                            stageDebugDetailHtml += '</div>';
                            debugStagesDetailsEl.innerHTML += stageDebugDetailHtml;
                        });
                    } else {
                        debugInfoContainer.style.display = 'none';
                    }

                    chartsContainerEl.style.maxHeight = '800px';
                    chartsContainerEl.style.overflowY = 'auto';
                    let allChartsHtml = '';
                    data.stages.forEach((stage, index) => {
                        const chartCanvasId = 'chart-stage-' + (stage.id !== undefined ? stage.id : index); 
                        allChartsHtml += `<div class="card mb-3"><div class="card-header">График для Этапа ${stage.stage_number} (Частота: ${stage.frequency_hz} Hz)</div><div class="card-body"><canvas id="${chartCanvasId}" style="height: 220px;"></canvas></div></div>`;
                    });
                    chartsContainerEl.innerHTML = allChartsHtml;

                    if (!window.charts) window.charts = {};

                    data.stages.forEach((stage, index) => {
                        const chartCanvasId = 'chart-stage-' + (stage.id !== undefined ? stage.id : index);
                        const canvasElement = document.getElementById(chartCanvasId);
                        if (!canvasElement) {
                            console.error(`[ChartJS Init - Этап ${stage.stage_number}] Canvas элемент "${chartCanvasId}" НЕ НАЙДЕН.`);
                            return;
                        }
                        const ctx = canvasElement.getContext('2d');
                        const datasets = [];
                        let chartHasData = false;

                        if (stage.full_signal_data && Array.isArray(stage.full_signal_data) && stage.full_signal_data.length > 0) {
                            const fullSignalPoints = stage.full_signal_data.map(p => ({ x: p.position * 100, y: p.amplitude }));
                            datasets.push({
                                label: `Амплитуда сигнала (Этап ${stage.stage_number})`,
                                data: fullSignalPoints,
                                borderColor: 'rgba(0, 123, 255, 0.8)',
                                borderWidth: 1, pointRadius: 0, fill: false, showLine: true, type: 'line', tension: 0.1, order: 1
                            });
                            chartHasData = true;
                        }

                        let minimaSource = stage.minima_table; 
                        if (minimaSource && Array.isArray(minimaSource) && minimaSource.length > 0) {
                            const minimaPoints = minimaSource.map(m => ({
                                x: m.position_m * 100,
                                y: m.amplitude !== undefined ? m.amplitude : (stage.full_signal_data && stage.full_signal_data.length > 0 ? Math.min(...stage.full_signal_data.map(p=>p.amplitude)) * 0.5 : 0.01) 
                            }));                            
                            datasets.push({
                                label: `Найденные минимумы (Этап ${stage.stage_number})`,
                                data: minimaPoints,
                                backgroundColor: 'rgba(255, 99, 132, 1)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                pointRadius: 5, pointHoverRadius: 7, showLine: false, type: 'scatter', order: 0
                            });
                            chartHasData = true;
                        }
                        
                        if (chartHasData) {
                            if(window.charts[chartCanvasId]) window.charts[chartCanvasId].destroy();
                            window.charts[chartCanvasId] = new Chart(ctx, {
                                type: 'scatter', 
                                data: { datasets: datasets },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: { 
                                            type: 'linear', 
                                            position: 'bottom', 
                                            title: { 
                                                display: true, 
                                                text: 'Положение трубы L, см' 
                                            } 
                                        },
                                        y: { 
                                            title: { 
                                                display: true, 
                                                text: 'Амплитуда сигнала, усл.ед.' 
                                            } 
                                        }
                                    },
                                    plugins: {
                                        legend: { 
                                            display: true 
                                        },
                                        tooltip: { 
                                            mode: 'index', 
                                            intersect: false,
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label.includes('Найденные минимумы')) {
                                                        label = 'Минимум';
                                                    }

                                                    if (label) {
                                                        label += ': ';
                                                    }
                                                    if (context.parsed.y !== null) {
                                                        label += `Ампл.: ${context.parsed.y.toFixed(3)}`;
                                                    }
                                                    if (context.parsed.x !== null) {
                                                        label += `, Поз.: ${context.parsed.x.toFixed(2)} см`; 
                                                    }
                                                    return label;
                                                }
                                            }
                                        },
                                        zoom: { 
                                            zoom: { 
                                                wheel: { enabled: true }, 
                                                pinch: { enabled: true }, 
                                                mode: 'xy' 
                                            }, 
                                            pan: { 
                                                enabled: true, 
                                                mode: 'xy' 
                                            } 
                                        }
                                    }
                                }
                            });
                        } else {
                            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                            ctx.font = "16px Arial"; ctx.fillStyle = "rgb(150,150,150)"; ctx.textAlign = "center";
                            ctx.fillText('Нет данных для отображения графика.', canvasElement.width / 2, canvasElement.height / 2);
                        }
                    });
                    
                    if (data.student_submitted_values_per_stage) {
                        data.student_submitted_values_per_stage.forEach((stage_data, idx) => {
                            const stageNum = idx + 1;
                            const speedInput = document.getElementById(`student-speed-stage${stageNum}`);
                            const gammaInput = document.getElementById(`student-gamma-stage${stageNum}`);
                            if (speedInput && stage_data.speed !== null) speedInput.value = stage_data.speed;
                            if (gammaInput && stage_data.gamma !== null) gammaInput.value = stage_data.gamma;
                        });
                        const finalGammaInput = document.getElementById('student-final-gamma');
                        if (finalGammaInput && data.student_final_gamma_submitted !== undefined && data.student_final_gamma_submitted !== null) {
                            finalGammaInput.value = data.student_final_gamma_submitted;
                        }
                    }

                    if (data.results_processing_status === 'success' || data.results_processing_status === 'fail' || data.results_processing_status === 'final_completed') {
                        studentResultsForm.querySelectorAll('input, button[type="submit"]').forEach(el => el.disabled = true);
                        let finalMessage = data.results_processing_status === 'success' || data.results_processing_status === 'final_completed' ? 
                            "<div class='alert alert-success'>Эксперимент успешно завершен. Введенные данные сохранены.</div>" :
                            "<div class='alert alert-danger'>Эксперимент завершен с ошибками. Введенные данные сохранены. Обратитесь к преподавателю, если нужна повторная попытка.</div>";
                        formMessageEl.innerHTML = finalMessage;
                    }

                } else {
                    experimentDataContainer.style.display = 'none';
                    experimentDataError.textContent = data.message || 'Не удалось загрузить данные эксперимента.';
                    experimentDataError.style.display = 'block';
                    console.error('Ошибка загрузки данных эксперимента:', data.message);
                }
            })
            .catch(error => {
                experimentDataLoading.style.display = 'none';
                experimentDataError.textContent = `Ошибка сети или сервера: ${error.message}. Пожалуйста, попробуйте обновить страницу.`;
                experimentDataError.style.display = 'block';
                console.error('Fetch error:', error);
            });

        studentResultsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            formMessageEl.innerHTML = '<div class="alert alert-info">Отправка результатов...</div>';

            const formData = new FormData(studentResultsForm);
            const dataToSend = {};
            for (let i = 1; i <= 3; i++) {
                dataToSend[`student_speed_stage${i}`] = formData.get(`student_speed_stage${i}`);
                dataToSend[`student_gamma_stage${i}`] = formData.get(`student_gamma_stage${i}`);
            }
            dataToSend['student_final_gamma'] = formData.get('student_final_gamma');
            
            console.log('Отправляемые данные студента:', dataToSend);

            fetch(`/api/experiment/${experimentId}/save-results/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Ответ сервера на сохранение результатов:', data);
                let messageHtml = '';
                if (data.status === 'success') {
                    messageHtml = `<div class="alert alert-success"><strong>${data.message}</strong> (Общий статус: ${data.overall_status === 'success' ? 'Успешно' : 'Неудача'})</div>`;
                    
                    /* // Убираем детальную таблицу для студентов
                    messageHtml += "<h5>Результаты по этапам:</h5>";
                    messageHtml += "<table class='table table-bordered'><thead><tr><th>Этап</th><th>Ваша V, м/с</th><th>Сист. V, м/с</th><th>Ошибка V, %</th><th>Ваша γ</th><th>Сист. γ</th><th>Ошибка γ, %</th></tr></thead><tbody>";
                    data.stages.forEach(s => {
                        messageHtml += `<tr>
                                            <td>${s.stage_number}</td>
                                            <td>${s.student_speed !== null ? s.student_speed : 'N/A'}</td>
                                            <td>${s.system_speed !== null ? s.system_speed.toFixed(2) : 'N/A'}</td>
                                            <td class="${s.error_percent_speed !== null && s.error_percent_speed > 5 ? 'text-danger' : 'text-success'}">${s.error_percent_speed !== null ? s.error_percent_speed.toFixed(2) + '%' : 'N/A'}</td>
                                            <td>${s.student_gamma !== null ? s.student_gamma : 'N/A'}</td>
                                            <td>${s.system_gamma !== null ? s.system_gamma.toFixed(3) : 'N/A'}</td>
                                            <td class="${s.error_percent_gamma !== null && s.error_percent_gamma > 5 ? 'text-danger' : 'text-success'}">${s.error_percent_gamma !== null ? s.error_percent_gamma.toFixed(3) + '%' : 'N/A'}</td>
                                        </tr>`;
                    });
                    messageHtml += '</tbody></table>';
                    */

                    // Добавляем информацию о финальной гамме
                    if (data.final_gamma_results) {
                        messageHtml += `<div class="alert alert-info mt-2">
                                            Финальная гамма (студент): ${data.final_gamma_results.student_final_gamma !== null && data.final_gamma_results.student_final_gamma !== undefined ? data.final_gamma_results.student_final_gamma : 'N/A'}<br>
                                            Финальная гамма (система): ${data.final_gamma_results.system_final_gamma !== null && data.final_gamma_results.system_final_gamma !== undefined ? data.final_gamma_results.system_final_gamma.toFixed(3) : 'N/A'}<br>
                                            Отклонение финальной гаммы: ${data.final_gamma_results.error_percent_final_gamma !== null && data.final_gamma_results.error_percent_final_gamma !== undefined ? data.final_gamma_results.error_percent_final_gamma.toFixed(2) + '%' : 'N/A'}
                                        </div>`;
                    }

                } else {
                    messageHtml = `<div class="alert alert-danger">Сетевая ошибка или ошибка сервера при отправке результатов: ${data.message}</div>`;
                }
                formMessageEl.innerHTML = messageHtml;
            })
            .catch(error => {
                console.error('Ошибка при отправке результатов:', error);
                formMessageEl.innerHTML = `<div class="alert alert-danger">Сетевая ошибка или ошибка сервера при отправке результатов: ${error.message}</div>`;
            });
        }); 
    }); 
</script>
{% endblock %}