{% extends "base.html" %}
{% load static %}

{% block title %}Расчет результатов эксперимента{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Эксперимент #<span id="experiment-id">{{ experiment_id }}</span>: Расчет результатов</h2>
    <hr>

    <div id="experiment-data-loading" class="alert alert-info">
        Загрузка данных эксперимента...
    </div>

    <div id="experiment-data-container" style="display: none;">
        <h4>Данные эксперимента:</h4>
        <p><strong>Температура воздуха:</strong> <span id="temperature"></span> °C</p>
        
        <div id="stages-data">
            <!-- Данные по этапам будут добавлены сюда динамически -->
        </div>

        <!-- НАЧАЛО: Блок для отладочной информации -->
        <div id="debug-info-container" style="display: none; margin-top: 20px; padding: 15px; border: 1px dashed #ccc; background-color: #f9f9f9;">
            <h5><span class="badge bg-warning">Отладочная информация</span></h5>
            
            <h6>Системные расчеты:</h6>
            <p><strong>Расчетный показатель адиабаты (γ):</strong> <span id="debug-system-gamma"></span></p>
            
            <h6>Детали по этапам (включая таблицы минимумов):</h6>
            <div id="debug-stages-details">
                <!-- Отладочная информация по этапам будет сюда добавлена -->
            </div>
        </div>
        <!-- КОНЕЦ: Блок для отладочной информации -->

        <hr>
        <h4>Графики минимумов по этапам:</h4>
        <div id="charts-container" class="mb-4">
            <!-- Графики будут добавлены сюда динамически -->
        </div>
        
        <hr>
        <h4>Ваши расчеты:</h4>
        <form id="student-results-form">
            {% csrf_token %}
            <div class="form-group mb-3">
                <label for="student-speed">Рассчитанная скорость звука (м/с):</label>
                <input type="number" step="0.01" class="form-control" id="student-speed" name="student_speed" required>
            </div>
            <div class="form-group mb-3">
                <label for="student-gamma">Рассчитанный показатель адиабаты:</label>
                <input type="number" step="0.001" class="form-control" id="student-gamma" name="student_gamma" required>
            </div>
            <button type="submit" class="btn btn-primary">Отправить результаты</button>
        </form>
        <div id="form-message" class="mt-3"></div>
    </div>

    <div id="experiment-data-error" class="alert alert-danger" style="display: none;">
        Не удалось загрузить данные эксперимента. Пожалуйста, попробуйте позже или обратитесь к преподавателю.
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const experimentId = {{ experiment_id }};
        const experimentDataLoading = document.getElementById('experiment-data-loading');
        const experimentDataContainer = document.getElementById('experiment-data-container');
        const experimentDataError = document.getElementById('experiment-data-error');
        
        const temperatureEl = document.getElementById('temperature');
        const stagesDataEl = document.getElementById('stages-data');
        const chartsContainerEl = document.getElementById('charts-container');
        
        const studentResultsForm = document.getElementById('student-results-form');
        const formMessageEl = document.getElementById('form-message');

        fetch(`/api/experiment/${experimentId}/student-data/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                experimentDataLoading.style.display = 'none';
                if (data.status === 'success') {
                    experimentDataContainer.style.display = 'block';
                    temperatureEl.textContent = data.global_temperature_celsius;

                    console.log('Получены данные эксперимента:', data);

                    const debugInfoContainer = document.getElementById('debug-info-container');
                    const debugSystemGammaEl = document.getElementById('debug-system-gamma');
                    const debugStagesDetailsEl = document.getElementById('debug-stages-details');

                    // --- НАЧАЛО ИЗМЕНЕНИЯ: Обновление заголовка отладочной информации ---
                    const debugHeaderSpan = debugInfoContainer.querySelector('h5 > span.badge');
                    if (debugHeaderSpan) {
                        if (data.results_processing_status === 'success' || data.experiment_status_raw === 'completed') {
                            debugHeaderSpan.textContent = 'Завершен';
                            debugHeaderSpan.classList.remove('bg-warning');
                            debugHeaderSpan.classList.add('bg-success');
                        }
                        // Если не выполнены условия выше, заголовок останется "Отладочная информация" с классом bg-warning
                    }
                    // --- КОНЕЦ ИЗМЕНЕНИЯ ---

                    if (data.debug_mode_for_student_profile) {
                        debugInfoContainer.style.display = 'block';
                        
                        if (data.system_calculated_results) {
                            debugSystemGammaEl.textContent = data.system_calculated_results.gamma !== null && data.system_calculated_results.gamma !== undefined ? data.system_calculated_results.gamma.toFixed(4) : 'Нет данных';
                        } else {
                            debugSystemGammaEl.textContent = 'Нет данных';
                        }

                        debugStagesDetailsEl.innerHTML = '';
                        data.stages.forEach(stage => {
                            let stageHtml = `<div class="mb-2 p-2 border rounded"><strong>Этап ${stage.stage_number} (Частота: ${stage.frequency_hz} Hz):</strong><br>`;
                            if (stage.minima_table && stage.minima_table.length > 0) {
                                stageHtml += '<table class="table table-sm table-bordered w-auto"><thead><tr><th>№</th><th>L, м</th></tr></thead><tbody>';
                                stage.minima_table.forEach(m => {
                                    stageHtml += `<tr><td>${m.minimum_number}</td><td>${m.position_m}</td></tr>`;
                                });
                                stageHtml += '</tbody></table>';
                            } else {
                                stageHtml += '<p class="text-muted small">Таблица минимумов отсутствует или пуста.</p>';
                            }
                            stageHtml += `Среднее ΔL: ${stage.average_delta_l_m !== null && stage.average_delta_l_m !== undefined ? stage.average_delta_l_m + ' м' : 'Нет данных'}<br>`;
                            stageHtml += '</div>';
                            debugStagesDetailsEl.innerHTML += stageHtml;
                        });

                    } else {
                        debugInfoContainer.style.display = 'none';
                    }

                    chartsContainerEl.style.maxHeight = '800px';
                    chartsContainerEl.style.overflowY = 'auto';

                    data.stages.forEach((stage, index) => {
                        console.log(`Этап ${stage.stage_number}, данные минимумов из API:`, stage.minima_table);
                        
                        const chartId = `chart-stage-${stage.stage_number}`;
                        
                        chartsContainerEl.innerHTML += `
                            <div class="card mb-3">
                                <div class="card-header bg-light py-1">
                                    <h5 class="mb-0">Этап ${stage.stage_number} (Частота: ${stage.frequency_hz} Hz)</h5>
                                </div>
                                <div class="card-body p-2">
                                    <div class="chart-container" style="height: 180px;">
                                        <canvas id="${chartId}"></canvas>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        const minimaDataForChart = stage.minima_table ? stage.minima_table.map(m => ({
                            position: m.position_m, 
                            amplitude: m.amplitude !== undefined ? m.amplitude : 0.5 
                        })) : [];
                        
                        console.log(`График ${chartId}, данные позиций/амплитуд для графика:`, minimaDataForChart);
                        
                        setTimeout(() => {
                            if (minimaDataForChart.length > 0) {
                                new Chart(document.getElementById(chartId), {
                                    type: 'scatter',
                                    data: {
                                        datasets: [{
                                            label: `Амплитуда сигнала (Этап ${stage.stage_number})`,
                                            data: minimaDataForChart.map(m => ({
                                                x: m.position,
                                                y: m.amplitude
                                            })),
                                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                            borderColor: 'rgb(75, 192, 192)',
                                            pointRadius: 5,
                                            pointHoverRadius: 7
                                        }]
                                    },
                                    options: {
                                        animation: false, // Отключаем анимацию для повышения производительности
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        return `Позиция: ${context.raw.x}, Амплитуда: ${context.raw.y.toExponential(4)}`;
                                                    }
                                                }
                                            },
                                            legend: {
                                                position: 'top',
                                                labels: {
                                                    boxWidth: 12,
                                                    font: {
                                                        size: 11
                                                    }
                                                },
                                                display: true
                                            }
                                        },
                                        scales: {
                                            x: {
                                                title: {
                                                    display: true,
                                                    text: 'Позиция',
                                                    font: {
                                                        size: 10
                                                    }
                                                },
                                                ticks: {
                                                    font: {
                                                        size: 10
                                                    }
                                                }
                                            },
                                            y: {
                                                title: {
                                                    display: true,
                                                    text: 'Амплитуда',
                                                    font: {
                                                        size: 10
                                                    }
                                                },
                                                ticks: {
                                                    font: {
                                                        size: 10
                                                    },
                                                    callback: function(value) {
                                                        return value.toExponential(1);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                                console.log(`График амплитуды ${chartId} успешно создан`);
                            } else {
                                const chartElement = document.getElementById(chartId);
                                if (chartElement) {
                                    chartElement.outerHTML = `<div class="alert alert-warning text-center p-1 small">Нет данных для построения графика.</div>`;
                                }
                            }
                        }, 0);
                    });

                } else {
                    experimentDataError.textContent = data.message || 'Произошла ошибка при загрузке данных.';
                    experimentDataError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching experiment data:', error);
                experimentDataLoading.style.display = 'none';
                experimentDataError.textContent = `Ошибка сети или сервера: ${error.message}. Пожалуйста, проверьте ваше подключение или попробуйте позже.`;
                experimentDataError.style.display = 'block';
            });

        studentResultsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            formMessageEl.textContent = ''; // Очищаем предыдущие сообщения
            formMessageEl.className = 'mt-3'; // Сбрасываем классы

            const formData = new FormData(studentResultsForm); // Используем FormData для CSRF и значений
            const studentSpeed = formData.get('student_speed');
            const studentGamma = formData.get('student_gamma');

            // Исправленный URL: убираем /lab_data в начале
            fetch(`/api/experiment/${experimentId}/save-results/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken') // CSRF из скрытого поля формы
                },
                body: JSON.stringify({
                    student_speed: studentSpeed ? parseFloat(studentSpeed) : null, // Преобразуем в число или null
                    student_gamma: studentGamma ? parseFloat(studentGamma) : null  // Преобразуем в число или null
                })
            })
            .then(response => response.json()) // Ожидаем JSON в любом случае
            .then(data => {
                if (data.status === 'success') {
                    formMessageEl.textContent = 'Ваши результаты успешно отправлены! ' + (data.message || '');
                    formMessageEl.className = 'alert alert-success mt-3';
                    // studentResultsForm.reset(); // Можно раскомментировать, если нужно очищать форму
                    
                    const submitButton = studentResultsForm.querySelector('button[type="submit"]');
                    const retryButtonContainer = document.getElementById('retry-button-container');


                    if (data.results_status === 'fail') {
                        if (data.comparison_message) {
                            formMessageEl.innerHTML += `<br>${data.comparison_message}`; // Используем innerHTML для <br>
                        }
                        if (submitButton) submitButton.disabled = false; // Разблокируем кнопку отправки

                        if (retryButtonContainer) {
                             // Показываем контейнер и кнопку (если кнопка уже там)
                            retryButtonContainer.style.display = 'block';
                            // Если кнопки "Пересдать" еще нет, ее можно создать и добавить сюда
                            // или предполагаем, что она уже есть в HTML и просто скрыта.
                            // Пример создания кнопки, если ее нет:
                            // if (!document.getElementById('retry-experiment-button')) {
                            //    const retryBtn = document.createElement('a');
                            //    retryBtn.href = `/lab_data/experiment/${experimentId}/retry/`;
                            //    retryBtn.className = 'btn btn-warning mt-2';
                            //    retryBtn.id = 'retry-experiment-button';
                            //    retryBtn.textContent = 'Пересдать эксперимент';
                            //    retryButtonContainer.appendChild(retryBtn);
                            // }
                        }
                         // Показываем кнопку "Пересдать" (предполагая, что она есть и имеет ID 'retry-experiment-button')
                        const retryBtnElement = document.getElementById('retry-experiment-button');
                        if (retryBtnElement) {
                            retryBtnElement.style.display = 'inline-block';
                        }


                    } else if (data.results_status === 'success'){
                        if (submitButton) submitButton.disabled = true; // Блокируем кнопку после успешной сдачи
                        if (retryButtonContainer) retryButtonContainer.style.display = 'none'; // Скрываем кнопку "Пересдать"
                        const retryBtnElement = document.getElementById('retry-experiment-button');
                        if (retryBtnElement) {
                             retryBtnElement.style.display = 'none';
                        }
                    }
                } else {
                    formMessageEl.textContent = 'Ошибка при отправке: ' + (data.message || 'Проверьте введенные данные.');
                    formMessageEl.className = 'alert alert-danger mt-3';
                }
            })
            .catch(error => {
                formMessageEl.textContent = 'Сетевая ошибка или ошибка сервера при отправке результатов. Проверьте консоль для деталей.';
                formMessageEl.className = 'alert alert-danger mt-3';
                console.error('Error submitting results:', error);
            });
        });
    });
</script>
{% endblock %} 