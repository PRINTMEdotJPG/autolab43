<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Эксперимент</title>
    <!-- Стили -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .stage-chart-container {
            position: relative;
            margin-top: 15px;
            width: 100%;
            height: 300px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
        }
        canvas {
            background-color: white;
        }
        .spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div id="app-container" class="container mt-4">
        <!-- Параметры эксперимента -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Параметры эксперимента</h5>
                <div class="mb-3">
                    <label for="temperatureInput" class="form-label">Температура (°C)</label>
                    <input type="number" class="form-control" id="temperatureInput" value="20">
                </div>
                <button id="saveParamsBtn" class="btn btn-primary">
                    <i class="bi bi-save"></i> Сохранить параметры
                </button>
            </div>
        </div>

        <!-- Этапы эксперимента -->
        <div class="stage-card card mb-3">
            <div class="card-body">
                <h5 class="card-title">
                    Этап <span class="stage-number">1</span>
                    <span class="badge bg-secondary float-end">Не начат</span>
                </h5>
                <div class="mb-3">
                    <label class="form-label">Частота (Гц)</label>
                    <input type="number" class="form-control stage-freq" value="1500">
                </div>
                <button class="btn btn-primary record-btn" data-stage="1">
                    <i class="bi bi-record-circle"></i> Начать запись
                </button>
                <div class="stage-progress progress mt-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
                <div class="stage-chart-container">
                    <canvas id="chart-step-1" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="stage-card card mb-3">
            <div class="card-body">
                <h5 class="card-title">
                    Этап <span class="stage-number">2</span>
                    <span class="badge bg-secondary float-end">Не начат</span>
                </h5>
                <div class="mb-3">
                    <label class="form-label">Частота (Гц)</label>
                    <input type="number" class="form-control stage-freq" value="2000">
                </div>
                <button class="btn btn-primary record-btn" data-stage="2" disabled>
                    <i class="bi bi-record-circle"></i> Начать запись
                </button>
                <div class="stage-progress progress mt-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
                <div class="stage-chart-container">
                    <canvas id="chart-step-2" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="stage-card card mb-3">
            <div class="card-body">
                <h5 class="card-title">
                    Этап <span class="stage-number">3</span>
                    <span class="badge bg-secondary float-end">Не начат</span>
                </h5>
                <div class="mb-3">
                    <label class="form-label">Частота (Гц)</label>
                    <input type="number" class="form-control stage-freq" value="2500">
                </div>
                <button class="btn btn-primary record-btn" data-stage="3" disabled>
                    <i class="bi bi-record-circle"></i> Начать запись
                </button>
                <div class="stage-progress progress mt-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
                <div class="stage-chart-container">
                    <canvas id="chart-step-3" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- График для финальных результатов -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Итоговый график</h5>
                <div class="chart-container">
                    <canvas id="finalChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>

        <!-- Кнопка завершения эксперимента -->
        <div class="mt-4 mb-4">
            <button id="completeExperimentBtn" class="btn btn-success">
                <i class="bi bi-flag-fill"></i> Завершить эксперимент
            </button>
        </div>

        <!-- Отладочная информация -->
        <div id="debug" class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Отладочная информация</h5>
                <pre id="debug-info" class="bg-light p-3" style="max-height: 200px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>

    <!-- Загрузка скриптов -->
    <script>
        // Функция для отладки
        function debugLog(msg) {
            console.log(msg);
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.textContent += msg + '\n';
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }

        // Функция для проверки готовности canvas
        function checkCanvasReady() {
            ['chart-step-1', 'chart-step-2', 'chart-step-3', 'finalChart'].forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    debugLog(`Canvas ${id} найден и готов`);
                    const context = canvas.getContext('2d');
                    if (context) {
                        debugLog(`Context для ${id} получен успешно`);
                    } else {
                        console.error(`Не удалось получить context для ${id}`);
                    }
                } else {
                    console.error(`Canvas ${id} не найден`);
                }
            });
        }

        // Функция для загрузки скрипта
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                debugLog(`Загрузка скрипта: ${src}`);
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    debugLog(`Скрипт загружен: ${src}`);
                    resolve();
                };
                script.onerror = (error) => {
                    console.error(`Ошибка загрузки скрипта ${src}:`, error);
                    reject(error);
                };
                document.body.appendChild(script);
            });
        }

        // Функция для последовательной загрузки всех скриптов
        async function loadAllScripts() {
            try {
                debugLog('Начинаем загрузку скриптов...');
                
                // Загружаем скрипты последовательно
                await loadScript('https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js');
                debugLog('Bootstrap загружен');
                
                await loadScript('https://cdn.jsdelivr.net/npm/chart.js');
                debugLog('Chart.js загружен');
                
                await loadScript('/static/js/charts.js');
                debugLog('charts.js загружен');
                
                await loadScript('/static/js/websocket.js');
                debugLog('websocket.js загружен');
                
                await loadScript('/static/js/recording.js');
                debugLog('recording.js загружен');
                
                await loadScript('/static/js/assistant_control.js');
                debugLog('assistant_control.js загружен');
                
                // Проверяем готовность canvas элементов
                debugLog('Проверяем canvas элементы...');
                checkCanvasReady();
                
                // Инициализируем приложение
                debugLog('Инициализируем приложение...');
                if (window.initializeApp) {
                    const success = await window.initializeApp();
                    if (success) {
                        debugLog('Приложение успешно инициализировано');
                    } else {
                        console.error('Ошибка при инициализации приложения');
                    }
                } else {
                    console.error('Функция initializeApp не найдена');
                }
                
            } catch (error) {
                console.error('Ошибка при загрузке скриптов:', error);
                debugLog(`Ошибка: ${error.message}`);
            }
        }

        // Запускаем загрузку скриптов после полной загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('DOM загружен');
            loadAllScripts();
        });
    </script>
</body>
</html> 