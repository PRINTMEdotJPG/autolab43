{% extends 'base.html' %}

{% block content %}
<div class="container">
    {% if user.role == 'student' %}
        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ full_name }}!</h1>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–ø–∏—Å–∏ -->
        <div class="audio-experiment card mb-4">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">üîä –ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç</h2>
            </div>
            <div class="card-body">
                <button id="recordBtn" class="btn btn-success btn-lg">
                    <i class="bi bi-mic"></i> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                </button>
                
                <div id="statusPanel" class="mt-3">
                    <div class="alert alert-info" id="connectionStatus">
                        –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
                    </div>
                    <div class="alert alert-secondary" id="recordingStatus">
                        –ó–∞–ø–∏—Å—å: –ù–µ –∞–∫—Ç–∏–≤–Ω–∞
                    </div>
                </div>
                
                <div id="resultsPanel" class="mt-4" style="display:none;">
                    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h4>
                    <div id="minimaList"></div>
                    <canvas id="waveform" width="800" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h5>
            </div>
            <div class="card-body">
                <div id="eventLog" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    {% endif %}
</div>

<script>
class AudioRecorderApp {
    constructor() {
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.socket = null;
        this.isRecording = false;
        
        this.recordBtn = document.getElementById('recordBtn');
        this.connectionStatus = document.getElementById('connectionStatus');
        this.recordingStatus = document.getElementById('recordingStatus');
        this.eventLog = document.getElementById('eventLog');
        this.resultsPanel = document.getElementById('resultsPanel');
        this.minimaList = document.getElementById('minimaList');
        this.waveformCanvas = document.getElementById('waveform');
        
        this.initWebSocket();
        this.setupEventListeners();
        this.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'info');
    }
    
    initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        this.socket = new WebSocket(`${protocol}//${window.location.host}/ws/audio/`);
        
        this.socket.onopen = () => {
            this.updateConnectionStatus('success', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
            this.recordBtn.disabled = false;
            this.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        };
        
        this.socket.onerror = (error) => {
            this.updateConnectionStatus('danger', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            this.log(`–û—à–∏–±–∫–∞ WebSocket: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
        };
        
        this.socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'analysis_result') {
                    this.showResults(data);
                } else if (data.type === 'error') {
                    this.log(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.message}`, 'error');
                }
            } catch (e) {
                this.log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${e}`, 'error');
            }
        };
    }
    
    setupEventListeners() {
        this.recordBtn.addEventListener('click', () => {
            if (this.isRecording) {
                this.stopRecording();
            } else {
                this.startRecording();
            }
        });
    }
    
    async startRecording() {
        try {
            this.log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'info');
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            this.audioChunks = [];
            
            this.mediaRecorder.ondataavailable = (event) => {
                this.audioChunks.push(event.data);
            };
            
            this.mediaRecorder.onstop = () => {
                this.sendAudioToServer();
                this.updateRecordingStatus('secondary', '–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            };
            
            this.mediaRecorder.start(100);
            this.isRecording = true;
            this.recordBtn.innerHTML = '<i class="bi bi-stop-circle"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            this.recordBtn.classList.replace('btn-success', 'btn-danger');
            this.updateRecordingStatus('info', '–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...');
            this.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞', 'success');
            
        } catch (error) {
            this.log(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`, 'error');
            this.updateRecordingStatus('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏');
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.isRecording = false;
            this.recordBtn.innerHTML = '<i class="bi bi-mic"></i> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
            this.recordBtn.classList.replace('btn-danger', 'btn-success');
            this.log('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
        }
    }
    
    sendAudioToServer() {
        if (this.audioChunks.length === 0) {
            this.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'warning');
            return;
        }
        
        const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        
        reader.onload = () => {
            const base64data = reader.result.split(',')[1];
            this.socket.send(JSON.stringify({
                type: 'audio_data',
                data: base64data,
                format: 'webm'
            }));
            this.log('–ê—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä', 'success');
        };
        
        reader.readAsDataURL(audioBlob);
    }
    
    showResults(data) {
    if (!data?.minima || !data?.waveform || !data?.sample_rate || !data?.duration) {
        this.log("–û—à–∏–±–∫–∞: –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞", "error");
        return;
    }

    this.resultsPanel.style.display = 'block';
    this.minimaList.innerHTML = data.minima.map(m => `
        <div class="alert alert-success mb-2">
            –í—Ä–µ–º—è: ${m.time} —Å–µ–∫, –ê–º–ø–ª–∏—Ç—É–¥–∞: ${m.amplitude.toFixed(4)}
        </div>
    `).join('');

    this.drawWaveformWithScale(data.waveform, data.sample_rate, data.duration);
    this.log(`–ü–æ–ª—É—á–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (${data.minima.length} –º–∏–Ω–∏–º—É–º–æ–≤)`, "success");
}
    
    drawWaveformWithScale(samples, sampleRate, duration) {
    const canvas = this.waveformCanvas;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const padding = 30;

    // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
    ctx.clearRect(0, 0, width, height);

    // –û—Å–∏ –∏ –ø–æ–¥–ø–∏—Å–∏
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.stroke();

    // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X (–≤—Ä–µ–º—è)
    ctx.fillStyle = '#000';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    for (let i = 0; i <= 5; i++) {
        const x = padding + (i / 5) * (width - 2 * padding);
        const time = (i * duration / 5).toFixed(2);
        ctx.fillText(time, x, height - 10);
    }

    // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ Y (–∞–º–ø–ª–∏—Ç—É–¥–∞)
    ctx.save();
    ctx.translate(10, height / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('–ê–º–ø–ª–∏—Ç—É–¥–∞', 0, 0);
    ctx.restore();

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞
    ctx.beginPath();
    samples.forEach((sample, index) => {
        const x = padding + (index / samples.length) * (width - 2 * padding);
        const y = height - padding - ((sample + 1) / 2) * (height - 2 * padding);
        index === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.strokeStyle = '#4a90e2';
    ctx.lineWidth = 2;
    ctx.stroke();
}
    
    log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.className = `alert alert-${type} mb-2 p-2`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        this.eventLog.prepend(entry);
    }
    
    updateConnectionStatus(type, message) {
        this.connectionStatus.className = `alert alert-${type}`;
        this.connectionStatus.textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${message}`;
    }
    
    updateRecordingStatus(type, message) {
        this.recordingStatus.className = `alert alert-${type}`;
        this.recordingStatus.textContent = `–ó–∞–ø–∏—Å—å: ${message}`;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    try {
        new AudioRecorderApp();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        document.getElementById('eventLog').innerHTML = `
            <div class="alert alert-danger">
                –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}
            </div>
        `;
    }
});
</script>

<style>
#waveform {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

#eventLog {
    max-height: 300px;
    overflow-y: auto;
}

#eventLog .alert {
    padding: 0.5rem 1rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
}

.audio-experiment .card-header {
    background: linear-gradient(45deg, #1a2980, #26d0ce);
    color: white;
}
</style>
{% endblock %}