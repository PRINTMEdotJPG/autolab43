{% extends 'base.html' %}

{% block content %}
<div class="container">
    {% if user.role == 'student' %}
        <!-- Контент для студентов -->
        <h1>Добро пожаловать, {{ full_name }}!</h1>
        
        <div class="user-info">
            <p><strong>Группа:</strong> {{ group_name }}</p>
            <p><strong>Роль:</strong> {{ role }}</p>
        </div>
        
        <div class="experiment-section">
            <h2>Эксперименты</h2>
            <form action="{% url 'start_experiment' %}" method="post" id="experiment-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary" id="start-btn">
                    Запустить эксперимент
                </button>
            </form>
            
            <div id="loading" class="mt-2" style="display: none;">
                <div class="spinner-border text-primary" role="status"></div>
                <span class="ms-2">Идет проведение эксперимента...</span>
            </div>
            
            <div id="messages" class="mt-3"></div>
            
            <script>
                document.getElementById('experiment-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('start-btn');
                    const loading = document.getElementById('loading');
                    const messagesDiv = document.getElementById('messages');
                
                    btn.disabled = true;
                    loading.style.display = 'block';
                    messagesDiv.innerHTML = '';
                
                    try {
                        const response = await fetch("{% url 'start_experiment' %}", {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                'Content-Type': 'application/json'
                            }
                        });
                
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.message || 'Ошибка сервера');
                        }
                
                        if (data.status === 'success') {
                            window.location.href = "{% url 'experiment_results' 0 %}".replace('0', data.experiment_id);
                        } else {
                            messagesDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                        }
                    } catch (error) {
                        messagesDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                    } finally {
                        btn.disabled = false;
                        loading.style.display = 'none';
                    }
                });
                </script>
            
            <a href="{% url 'download_manual' %}" class="btn btn-info" target="_blank">
                Открыть методичку к эксперименту
            </a>
        </div>


    {% elif user.role == 'teacher' %}
        <!-- Контент для преподавателей -->
        <h1>Группы студентов</h1>
        
        <div class="groups-list">
            {% for group in groups_with_students %}
            <div class="card mb-3">
                <div class="card-header">
                    <h2>{{ group.name }}</h2>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for student in group.students %}
                        <li class="list-group-item">
                            {{ student.full_name }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}