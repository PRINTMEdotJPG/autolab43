{% extends 'base.html' %}

{% block content %}
<div class="container">
    {% if user.role == 'student' %}
        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ full_name }}!</h1>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–ø–∏—Å–∏ -->
        <div class="audio-experiment card mb-4">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">üîä –ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç</h2>
            </div>
            <div class="card-body">
                <button id="recordBtn" class="btn btn-success btn-lg">
                    <i class="bi bi-mic"></i> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                </button>
                
                <div id="statusPanel" class="mt-3">
                    <div class="alert alert-info" id="connectionStatus">
                        –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
                    </div>
                    <div class="alert alert-secondary" id="recordingStatus">
                        –ó–∞–ø–∏—Å—å: –ù–µ –∞–∫—Ç–∏–≤–Ω–∞
                    </div>
                </div>
                
                <div id="resultsPanel" class="mt-4" style="display:none;">
                    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü–∏–∏</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div id="minimaList"></div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–∏–Ω–∏–º—É–º:</strong>
                                <div id="lastMinimaInfo"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h5>–ì—Ä–∞—Ñ–∏–∫ —Å–∏–≥–Ω–∞–ª–∞</h5>
                        <canvas id="waveform" width="800" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h5>
            </div>
            <div class="card-body">
                <div id="eventLog" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    {% endif %}
</div>

<script>
class AudioRecorderApp {
    constructor() {
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.socket = null;
        this.isRecording = false;
        this.sampleRate = null;
        this.duration = null;
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        this.recordBtn = document.getElementById('recordBtn');
        this.connectionStatus = document.getElementById('connectionStatus');
        this.recordingStatus = document.getElementById('recordingStatus');
        this.eventLog = document.getElementById('eventLog');
        this.resultsPanel = document.getElementById('resultsPanel');
        this.minimaList = document.getElementById('minimaList');
        this.lastMinimaInfo = document.getElementById('lastMinimaInfo');
        this.waveformCanvas = document.getElementById('waveform');
        
        this.initWebSocket();
        this.setupEventListeners();
        this.log('–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'info');
    }
    
    initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        this.socket = new WebSocket(`${protocol}//${window.location.host}/ws/audio/`);
        
        this.socket.onopen = () => {
            this.updateConnectionStatus('success', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
            this.recordBtn.disabled = false;
            this.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        };
        
        this.socket.onerror = (error) => {
            this.updateConnectionStatus('danger', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            this.log(`–û—à–∏–±–∫–∞ WebSocket: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
        };
        
        this.socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'analysis_result') {
                    this.showResults(data);
                } else if (data.type === 'error') {
                    this.log(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.message}`, 'error');
                }
            } catch (e) {
                this.log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${e}`, 'error');
            }
        };
    }
    
    setupEventListeners() {
        this.recordBtn.addEventListener('click', () => {
            if (this.isRecording) {
                this.stopRecording();
            } else {
                this.startRecording();
            }
        });
    }
    
    async startRecording() {
        try {
            this.log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'info');
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            this.audioChunks = [];
            
            this.mediaRecorder.ondataavailable = (event) => {
                this.audioChunks.push(event.data);
            };
            
            this.mediaRecorder.onstop = () => {
                this.sendAudioToServer();
                this.updateRecordingStatus('secondary', '–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            };
            
            this.mediaRecorder.start(100);
            this.isRecording = true;
            this.recordBtn.innerHTML = '<i class="bi bi-stop-circle"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            this.recordBtn.classList.replace('btn-success', 'btn-danger');
            this.updateRecordingStatus('info', '–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...');
            this.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞', 'success');
            
        } catch (error) {
            this.log(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`, 'error');
            this.updateRecordingStatus('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏');
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.isRecording = false;
            this.recordBtn.innerHTML = '<i class="bi bi-mic"></i> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
            this.recordBtn.classList.replace('btn-danger', 'btn-success');
            this.log('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
        }
    }
    
    sendAudioToServer() {
        if (this.audioChunks.length === 0) {
            this.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'warning');
            return;
        }
        
        const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        
        reader.onload = () => {
            const base64data = reader.result.split(',')[1];
            this.socket.send(JSON.stringify({
                type: 'audio_data',
                data: base64data,
                format: 'webm'
            }));
            this.log('–ê—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä', 'success');
        };
        
        reader.readAsDataURL(audioBlob);
    }
    
    showResults(data) {
        if (!data?.minima || !data?.waveform || !data?.positions) {
            this.log("–û—à–∏–±–∫–∞: –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞", "error");
            return;
        }

        this.sampleRate = data.sample_rate;
        this.duration = data.duration;
        
        this.resultsPanel.style.display = 'block';
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∏–Ω–∏–º—É–º–æ–≤
        this.minimaList.innerHTML = data.minima.map((m, i) => `
            <div class="alert ${i === data.minima.length - 1 ? 'alert-success' : 'alert-secondary'} mb-2 p-2">
                <strong>–ú–∏–Ω–∏–º—É–º #${i+1}</strong><br>
                –ü–æ–∑–∏—Ü–∏—è: ${m.position.toFixed(4)} –º<br>
                –í—Ä–µ–º—è: ${m.time.toFixed(2)} —Å<br>
                –ê–º–ø–ª–∏—Ç—É–¥–∞: ${m.amplitude.toFixed(4)}
            </div>
        `).join('');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –º–∏–Ω–∏–º—É–º–µ
        if (data.minima.length > 0) {
            const last = data.minima[data.minima.length - 1];
            this.lastMinimaInfo.innerHTML = `
                –ü–æ–∑–∏—Ü–∏—è: <strong>${last.position.toFixed(4)} –º</strong><br>
                –í—Ä–µ–º—è: <strong>${last.time.toFixed(2)} —Å</strong><br>
                –ê–º–ø–ª–∏—Ç—É–¥–∞: <strong>${last.amplitude.toFixed(4)}</strong>
            `;
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        this.drawWaveform(data.waveform, data.positions, data.minima);
        this.log(`–ü–æ–ª—É—á–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (${data.minima.length} –º–∏–Ω–∏–º—É–º–æ–≤)`, "success");
    }
    
    drawWaveform(samples, positions, minima) {
        const canvas = this.waveformCanvas;
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 40;
        
        // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
        ctx.clearRect(0, 0, width, height);
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–æ–≤
        const maxPos = Math.max(...positions);
        const maxAmp = Math.max(...samples.map(Math.abs));
        
        // –û—Å–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 1;
        
        // –û—Å—å X (–ø–æ–∑–∏—Ü–∏—è)
        ctx.beginPath();
        ctx.moveTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();
        
        // –û—Å—å Y (–∞–º–ø–ª–∏—Ç—É–¥–∞)
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.stroke();
        
        // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X
        ctx.fillStyle = '#000';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        for (let i = 0; i <= 5; i++) {
            const x = padding + (i / 5) * (width - 2 * padding);
            const pos = (i * maxPos / 5).toFixed(2);
            ctx.fillText(pos, x, height - 20);
        }
        ctx.fillText('–ü–æ–∑–∏—Ü–∏—è —Ç—Ä—É–±—ã (–º)', width / 2, height - 5);
        
        // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ Y
        ctx.save();
        ctx.translate(15, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.textAlign = 'center';
        ctx.fillText('–ê–º–ø–ª–∏—Ç—É–¥–∞ —Å–∏–≥–Ω–∞–ª–∞', 0, 0);
        ctx.restore();
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ (—Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
        ctx.beginPath();
        samples.forEach((sample, i) => {
            const x = padding + (positions[i] / maxPos) * (width - 2 * padding);
            const y = height - padding - (Math.abs(sample) / maxAmp * (height - 2 * padding));
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.strokeStyle = '#4a90e2';
        ctx.lineWidth = 1.5;
        ctx.stroke();
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∏–Ω–∏–º—É–º–æ–≤
        minima.forEach(m => {
            const x = padding + (m.position / maxPos) * (width - 2 * padding);
            const y = height - padding - (Math.abs(m.amplitude) / maxAmp * (height - 2 * padding));
            
            // –ú–∞—Ä–∫–µ—Ä –º–∏–Ω–∏–º—É–º–∞
            ctx.fillStyle = '#dc3545';
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // –õ–∏–Ω–∏—è –∫ –ø–æ–¥–ø–∏—Å–∏
            ctx.strokeStyle = 'rgba(220, 53, 69, 0.5)';
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, height - padding + 15);
            ctx.stroke();
            
            // –ü–æ–¥–ø–∏—Å—å –ø–æ–∑–∏—Ü–∏–∏
            ctx.fillStyle = '#dc3545';
            ctx.fillText(m.position.toFixed(3), x, height - padding + 30);
        });
    }
    
    log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.className = `alert alert-${type} mb-2 p-2`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        this.eventLog.prepend(entry);
    }
    
    updateConnectionStatus(type, message) {
        this.connectionStatus.className = `alert alert-${type}`;
        this.connectionStatus.textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${message}`;
    }
    
    updateRecordingStatus(type, message) {
        this.recordingStatus.className = `alert alert-${type}`;
        this.recordingStatus.textContent = `–ó–∞–ø–∏—Å—å: ${message}`;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', () => {
    try {
        new AudioRecorderApp();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        document.getElementById('eventLog').innerHTML = `
            <div class="alert alert-danger">
                –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}
            </div>
        `;
    }
});
</script>

<style>
#waveform {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 20px;
}

#eventLog {
    max-height: 300px;
    overflow-y: auto;
}

#eventLog .alert {
    padding: 0.5rem 1rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
}

.audio-experiment .card-header {
    background: linear-gradient(45deg, #1a2980, #26d0ce);
    color: white;
}

#minimaList .alert {
    transition: all 0.3s ease;
}

#minimaList .alert:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#lastMinimaInfo {
    font-size: 1.1rem;
}
</style>
{% endblock %}